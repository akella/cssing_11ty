---
title: "Одноразовый expression"
date: "2007-12-06"
categories: 
  - "xhtmlcss"
  - "useful"
---

Все уже часто сталкивались с специфическими для IE expressions, однако не все знают (я например не знал), что их можно оптимизировать. Об одном из приемов и пойдет дальше речь.

### Проблема

Наверняка многие хакеры замечали, что когда expression становится много, то сайт начинает притормаживать в IE. Оно и понятно — они ведь исполняются при каждом действии на странице, будь то клик, наведение мышки, или ресайз экрана. [Cмотрите сами](http://cssing.org.ua/examples/expression/bad.html). Для некоторых скриптов так и должно быть (min-width например), другим же достаточно одного выполнения(PNG fix, :first-child etc). О том как заставить их исполняться только один раз при загрузке и идет дальше речь.

### Решение

Все решения используют один и тот же прием. Есть некий "флаг", при наличии которого expression выполняется, скрипты же пытаются при первом же исполнении этот флаг убрать.

### Вариант решения

Первый вариант выглядит так:

1. jscript: expression(
2. this.p ? 0 : (
3. //а здесь пишем нужный нам код,
4. this.p = 1
5. )
6. );

В данном случае в качестве флага используется абстрактное и несуществующее в спецификации свойство "p". При первом выполнении, переменной p будет присвоена 1, а также выполнено наше действие. Таким образом при каждом следующем выполнении скрипта будет выполняться только `this.p = 0`. Что гораздо быстрее любых других операций.

### Яндекс вариант

Вариация(false true переставили местами) на тему этого способа используемая в верстке Яндекса:

1. b:expression(
2. !this.a?
3. (this.a=1, (this.previousSibling?this.innerHTML='&nbsp;&middot;' + this.innerHTML:0)):
4. 0
5. );

В частности, этот скрипт ставит точки-разделители перед всеми "чайлдами", кроме первого — такая вот эмуляция first-child. Скорее всего принадлежит руке большого и уважаемого мною профессионала в верстке — [Виталия Харисова](http://vitaly.harisov.name/)

### Второй тип, я использую

Есть и второй тип, используется CSS свойство, которое потом в самом expression "сбрасывается", так, что expression при первом выполнении как бы "удаляет" сам себя:

1. background-image:expression(
2. this.runtimeStyle.backgroundImage = 'none',
3. //а здесь пишем нужный нам код
4. );

`background-image` тут играет лишь роль флага, на самом деле скриптить таким способом можно все, что вам нужно, как-то так выглядит эмуляция :first-child:

1. background-image:expression(
2. this.runtimeStyle.backgroundImage = 'none',
3. this.previousSibling?false:this.className += 'first-child'
4. );

Когда мы присваиваем свойству `none`, соответственно и expression перестает исполняться.

Безопасно вместо `background-image` использовать всякие редкие свойства вроде `azimuth`.

### Изучать дальше

Вообще за поднятую тему оптимизации expression спасибо [Павлу Корнилову](http://lusever.ru/) выступившему с соответствующим докладом на ClientSide 2007.

Следует помнить, что одноразовые expression нельзя применять для min-width, min-height и прочего. По понятным причинам подсчеты произведутся только при загрузке страницы.

- [Пример трех одноразовых expression](http://cssing.org.ua/examples/expression/) а так же [пример одного обычного](http://cssing.org.ua/examples/expression/bad.html)
- [Текст доклада Корнилова на ClientSide](http://lusever.ru/proceedings/thin_css/index.html) и [жж-пост про это](http://lusever.livejournal.com/15868.html), рекомендую ознакомиться с презентацией(внизу текста на его сайте есть линк)
- [PNG fix](http://komodomedia.com/blog/index.php/2007/11/05/css-png-image-fix-for-ie/) использующий прием оптимизации, в комментариях есть несколько способов оптимизации
- [PNG прозрачность у Харисова](http://harisov.livejournal.com/58661.html) с использованием "одноразовости"
